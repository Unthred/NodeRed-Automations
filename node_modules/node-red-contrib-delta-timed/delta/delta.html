<script type="text/javascript">
	function pad(str, max) {
		str = str.toString();
		return str.length < max ? pad("0" + str, max) : str;
	}

	RED.nodes.registerType('delta', {
		category: 'function',
		color: '#C0C0C0',
		defaults: {
			name: { value: '' },
			topic: { value: null },
			timetype: { value: 'null', required: true },
			timeperiod: {
				value: null, validate: function (v) {
					return ((v === null) || (typeof v === "object" && v.begin.hour !== null && v.begin.minute !== null && v.end.hour !== null && v.end.minute !== null));
				}
			},
			interval: { value: 60 },
			loop_emit: { value: false },
			threshold: { value: null }
		},
		inputs: 1,
		outputs: 1,
		icon: 'delta-node-icon.png',
		inputLabels: "Changing data",
		outputLabels: "Result",
		label: function () {
			return this.name || 'delta'
		},
		oneditprepare: function () {
			$("#node-input-period").typedInput({
				types: ["num"]
			});
			if (this.loop_emit) $("#period-emit-checkbox").attr("checked", true)

			$("#timeperiod-row, #period-row, #loop-trig").hide();

			for (var i = 0; i < 24; i++) {
				$("#input-timeperiod-begin-wrapper > #hour-selection").append($('<option>', {
					value: i,
					text: pad(i, 2)
				}));
				$("#input-timeperiod-end-wrapper > #hour-selection").append($('<option>', {
					value: i,
					text: pad(i, 2)
				}));

				if (i * 5 < 60) {
					$("#input-timeperiod-begin-wrapper > #minute-selection").append($('<option>', {
						value: i * 5,
						text: pad(i * 5, 2)
					}));
					$("#input-timeperiod-end-wrapper > #minute-selection").append($('<option>', {
						value: i * 5,
						text: pad(i * 5, 2)
					}));
				}
			}

			//replace old value
			$("#input-period-interval").val(this.interval || 60);
			$("#timeperiod-selection").val(this.timetype || "interval");
			switch (this.timetype) {
				case "null": {
					$("#period-row, #timeperiod-row, #loop-trig").hide();
					break;
				}
				case "timeperiod": {
					$("#period-row, #loop-trig").hide();
					$("#timeperiod-row").show();
					$("#input-timeperiod-begin-wrapper > #hour-selection").val(this.timeperiod.begin.hour)
					$("#input-timeperiod-begin-wrapper > #minute-selection").val(this.timeperiod.begin.minute)
					$("#input-timeperiod-end-wrapper > #hour-selection").val(this.timeperiod.end.hour)
					$("#input-timeperiod-end-wrapper > #minute-selection").val(this.timeperiod.end.minute)
					break;
				}
				default: {
					$("#period-row, #loop-trig").show();
					$("#timeperiod-row").hide();
					break;
				}
			}

			$("#timeperiod-selection").change(function () {
				switch ($("#timeperiod-selection").val()) {
					case "null": {
						$("#period-row, #timeperiod-row, #loop-trig").hide();
						break;
					}
					case "timeperiod": {
						$("#period-row, #loop-trig").hide();
						$("#timeperiod-row").show();
						break;
					}
					default: {
						$("#period-row, #loop-trig").show();
						$("#timeperiod-row").hide();
						break;
					}
				}
			})
		},
		oneditsave: function () {
			var node = this;
			this.timetype = $("#timeperiod-selection").val();
			switch ($("#timeperiod-selection").val()) {
				case "timeperiod": {
					this.timeperiod = { begin: { hour: $("#input-timeperiod-begin-wrapper > #hour-selection").val(), minute: $("#input-timeperiod-begin-wrapper > #minute-selection").val() }, end: { hour: $("#input-timeperiod-end-wrapper > #hour-selection").val(), minute: $("#input-timeperiod-end-wrapper > #minute-selection").val() } };
					break;
				}
				case "interval": {
					this.interval = $("#input-period-interval").val();
					this.loop_emit = $("#period-emit-checkbox").is(":checked")
					break;
				}
				default: {
					break;
				}
			}
		}
	});

</script>


<script type="text/x-red" data-template-name="delta">
	<div class="form-row">
		<label for="node-input-name"><i class="icon-tag"></i> Name</label>
		<input type="text" id="node-input-name" placeholder="Name">
	</div>

	<div class="form-row">
		<label for="node-input-topic"><i class="fa fa-tasks"></i> Topic</label>
		<input type="text" id="node-input-topic" placeholder="Topic">
	</div>

	<div class="form-row" id="timetype-row">
		<label for="node-input-timetype"><i class="fa fa-clock-o"></i> Timetype</label>
		<select id="timeperiod-selection">
				<option value="null" selected>No period</option>
				<option value="interval">By interval</option>
				<option value="timeperiod">By timeperiod</option>
			</select>
	</div>
	<div class="form-row" id="period-row">
		<label for="input-period-interval"><i class="icon-tag"></i> Period (min)</label>
		<span id="period-interval-wrapper"><input type="text" id="input-period-interval" placeholder="60"></span>
	</div>
	<div class="form-row" id="loop-trig">
		<label for="input-period-interval"><i class="fa fa-minus-square-o"></i> Only emit in period ending</label>
		<input id="period-emit-checkbox" type="checkbox" />
	</div>
	<div class="form-row" id="timeperiod-row">
		<div id="timeperiod-begin-wrapper">
			<label for="node-input-timeperiod-begin-wrapper"><i class="fa fa-play-circle-o"></i> Beginning</label>
			<div id="input-timeperiod-begin-wrapper">
				<select id="hour-selection"></select>
				<select id="minute-selection"></select>
			</div>
		</div>
		<div id="timeperiod-end-wrapper">
			<label for="input-timeperiod-end-wrapper"><i class="fa fa-stop-circle-o"></i> Ending</label>
			<div id="input-timeperiod-end-wrapper">
				<select id="hour-selection"></select>
				<select id="minute-selection"></select>
			</div>
		</div>
	</div>

	<div class="form-row" id="treshold-row">
		<label for="node-input-threshold"><i class="fa fa-caret-square-o-up"></i> Threshold (optional)</label>
		<input type="text" id="node-input-threshold" placeholder="Ex : 500">
	</div>
</script>


<script type="text/x-red" data-help-name="delta">
	<h3>Details</h3>
	<p>Computes the difference between messages, including optionaly a period of time.</p>
	<h3>Configuration</h3>
	<dl class="message-properties">
		<dt>Time type <span class="property-type">interval | timeperiod</span></dt>
		<dd>Explaining this category will let the node choose the best way to work</dd>

		<dt>No period type <span class="property-type">null</span></dt>
		<dd>
			By choosing this option, the node will check by pair the last value and the incoming value.
		</dd>

		<dt>Interval type <span class="property-type">number</span></dt>
		<dd>
			By choosing this option, the node will perform his check for each period defined
			<dl class="message-properties">
				<dt>Period <span class="property-type">number</span></dt>
				<dd>The period, in min</dd>
				<dt>Only emit in period ending<span class="property-type">Boolean</span></dt>
				<dd>If checked, the node will send message only when the period is on ending</dd>
			</dl>
		</dd>

		<dt>Timeperiod type <span class="property-type">Times</span></dt>
		<dd>
			By choosing this option, the node will perform his check between the timeperiod defined every minute. If the beginning time
			is the same as the ending time, then the node will loop with a reset at the time defined
			<dl class="message-properties">
				<dt>Begin <span class="property-type">Time</span></dt>
				<dd>The beginning time</dd>
				<dt>End <span class="property-type">Time</span></dt>
				<dd>The ending time</dd>
			</dl>
		</dd>
		<dt>Threshold <span class="property-type">number</span> </dt>
		<dd>If defined, fire message only when threshold is reached</dd>
	</dl>

	<h3>Input</h3>
	<dl class="message-properties">
		<dt>payload <span class="property-type">number | string | array | object</span></dt>
		<dd>The value to check change on</dd>
	</dl>
	<h3>Output</h3>
	<dl class="message-properties">
		<dt>payload <span class="property-type">number</span></dt>
		<dd>If the threshold is defined, the sum of variation between time, otherwise the variation between values</dd>
	</dl>

	Don't forget to check the full output message, some property will tell you why a message was send.
</script>